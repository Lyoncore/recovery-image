#!/bin/bash
set -x
if [ ! -d /var/log/recovery ]; then
    mkdir /var/log/recovery
fi

exec &> >(tee -a "/var/log/recovery/curtin-wrapper.log")

curtin_conf=""
while getopts "c:" opt 2> /dev/null; do
    case "$opt" in
    c)  curtin_conf=$OPTARG
        ;;
    esac
done

if [ -n "$curtin_conf" ]; then
    # curtin-cfe to edit the partition
    /cdrom/recovery/bin/curtin-cfe -c $curtin_conf -r /cdrom/recovery/config.yaml

    # recovery.bin to do the partitioning
    # Check the recovery type
    for x in $(cat /proc/cmdline); do
        case ${x} in
            recoverytype=*)
                recoverytype=${x#*=}
            ;;
            recoveryos=*)
                recoveryos=${x#*=}
            ;;
        esac
    done
    LABEL=$(awk -F ": " '/filesystem-label/{print $2 }' /cdrom/recovery/config.yaml)

    # install efibootmgr if it's not been installed by default
    apt install -y efibootmgr

    # check the swap partition is been enabled
    # it needs to be off or it cannot do the repartition
    swapdev=$(swapon --noheadings | cut -d " " -f 1)
    if [ -n "$swapdev" ]; then
        swapoff $swapdev
    fi

    # run the recovery.bin
    /cdrom/recovery/bin/recovery.bin $recoverytype $LABEL $recoveryos
    ret=$?
    if [ $ret == 85 ]; then
        reboot
    elif [ $ret != 0 ]; then
        exit 1
    fi
fi

# curtin to process the installation
/usr/bin/curtin $@
