#!/bin/bash
set -x
exec &> >(tee -a "/var/log/headless_installer.log")

display_msg() {
    echo $1 | tee /dev/tty1
    echo $2 | tee /dev/ttyS0
}

#disable login prompt
systemctl stop getty@tty1.service
systemctl disable getty@tty1.service
systemctl stop serial-getty@ttyS0.service
systemctl disable serial-getty@ttyS0.service
systemctl daemon-reload

# check the swap partition is been enabled
# it needs to be off or it cannot do the repartition
swapdev=$(swapon --noheadings | cut -d " " -f 1)
if [ -n "$swapdev" ]; then
    swapoff $swapdev
fi
# trigger headless_installer
/cdrom/recovery/bin/recovery.bin headless_installer INSTALLER ubuntu_classic_curtin

if [ $? -eq 0 ]; then
    #copy the log if success
    LABEL=$(awk -F ": " '/filesystem-label/{print $2 }' /cdrom/recovery/config.yaml)
    DEVPATH=$(findfs LABEL=$LABEL)
    mount $DEVPATH /mnt
    mkdir -p /mnt/var/log/recovery
    cp /var/log/headless_installer.log /mnt/var/log/recovery
    umount /mnt

    poweroff
else
    #stop and generate the log
    display_msg "install failed!!!!!!!!!!!!!!!"
    display_msg "see the log /var/log/headless_installer.log"
fi

# re-enable login prompt
systemctl enable getty@tty1.service
systemctl enable serial-getty@ttyS0.service
systemctl restart getty@tty1.service
systemctl restart serial-getty@ttyS0.service
