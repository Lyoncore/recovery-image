#!/bin/bash
set -x
if [ ! -d /var/log/recovery ]; then
   mkdir /var/log/recovery
fi

exec &> >(tee -a "/var/log/recovery/recovery_process.log" /dev/ttyS0)

display_msg() {
    echo $1 | tee /dev/tty1
    echo $1 | tee /dev/ttyS0
}

#disable login prompt
systemctl stop getty@tty1.service
systemctl disable getty@tty1.service
systemctl stop serial-getty@ttyS0.service
systemctl disable serial-getty@ttyS0.service
systemctl daemon-reload

# Check the recovery type
for x in $(cat /proc/cmdline); do
    case ${x} in
        recoverytype=*)
            recoverytype=${x#*=}
        ;;
        recoveryos=*)
            recoveryos=${x#*=}
        ;;
        recoverylabel=*)
            recoverylabel=${x#*=}
        ;;
    esac
done

# check the swap partition is been enabled
# it needs to be off or it cannot do the repartition
swapdev=$(swapon --noheadings | cut -d " " -f 1)
if [ -n "$swapdev" ]; then
    swapoff $swapdev
fi
# trigger recovery.bin 
/cdrom/recovery/bin/recovery.bin $recoverytype $recoverylabel ubuntu_classic_curtin 2>&1 | tee /var/log/recovery/recovery.bin.prelog
ret=${PIPESTATUS[0]}
if [ $ret -eq 0 ] && [ ! -f /var/log/curtin/curtin-error-logs.tar ]; then
    if [ "$recoverytype" != "headless_installer" ]; then
        # remove installer default user
        usr=$(cat /target/etc/passwd | grep 1000 | cut -d ":" -f 1)
        chroot /target userdel -rf $usr
        #copy the log if success
        LABEL=$(awk -F ": " '/filesystem-label/{print $2 }' /cdrom/recovery/config.yaml)
        DEVPATH=$(findfs LABEL=$LABEL)
        mount $DEVPATH /mnt
        mkdir -p /mnt/var/log/recovery
        cp /var/log/recovery/* /mnt/var/log/recovery
        umount /mnt
        reboot
    else
        poweroff
    fi
elif [ $ret -eq 85 ]; then
    reboot
else
    rm /lib/systemd/system/getty@.service.d/*
    rm /lib/systemd/system/serial-getty@.service.d/*
    #stop and generate the log
    display_msg "recovery process failed!!!!!!!!!!!!!!!"
    display_msg "see the log /var/log/recovery/recovery_process.log"
    if [ -f /var/log/curtin/curtin-error-logs.tar ]; then
        display_msg "see the log /var/log/curtin/curtin-error-logs.tar"
    fi
fi

# re-enable login prompt
systemctl enable getty@tty1.service
systemctl enable serial-getty@ttyS0.service
systemctl start getty@tty1.service
systemctl start serial-getty@ttyS0.service
